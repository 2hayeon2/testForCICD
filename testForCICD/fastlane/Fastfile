default_platform(:ios)

platform :ios do

  PROJECT_NAME = "testForCICD"

  desc "Build, test, lint, and increment build number"
  lane :full_ci do
    begin
      UI.message "ğŸ‘‰ [1/4] Running SwiftLint..."
      sh("swiftlint")

      UI.message "ğŸ‘‰ [2/4] Running tests..."
      run_tests

      UI.message "ğŸ‘‰ [3/4] Incrementing build number..."
      increment_build_number

      UI.message "ğŸ‘‰ [4/4] Building the app..."
      build_app(
        scheme: PROJECT_NAME,
        skip_package_ipa: true,
        skip_profile_detection: true,
        export_method: "development",
        silent: true
      )

      slack(message: "âœ… full_ci succeeded ğŸ‰", success: true)
    rescue => error
      slack(message: "âŒ full_ci failed: #{error}", success: false)
      raise error
    end
  end

  desc "Build the app only"
  lane :build do
    begin
      UI.message "ğŸš§ Building the app..."
      build_app(
        scheme: PROJECT_NAME,
        skip_package_ipa: true,
        skip_profile_detection: true,
        export_method: "development",
        silent: true
      )
      slack(message: "âœ… build succeeded", success: true)
    rescue => error
      slack(message: "âŒ build failed: #{error}", success: false)
      raise error
    end
  end

  desc "Run tests"
  lane :test do
    begin
      UI.message "âœ… Running tests..."
      run_tests
      slack(message: "âœ… test succeeded", success: true)
    rescue => error
      slack(message: "âŒ test failed: #{error}", success: false)
      raise error
    end
  end

  desc "Run SwiftLint"
  lane :lint do
    begin
      UI.message "ğŸ§¹ Running SwiftLint..."
      sh("swiftlint")
      slack(message: "âœ… lint succeeded", success: true)
    rescue => error
      slack(message: "âŒ lint failed: #{error}", success: false)
      raise error
    end
  end

end
